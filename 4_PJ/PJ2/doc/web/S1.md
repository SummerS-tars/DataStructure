# S1 方案：超薄 HTTP 包装（子进程调用 engine）

目标：在不重写核心 C++ 的前提下，提供最小可用的 Web 能力。做法是新增一个“非交互 engine 可执行文件”，用纯文本契约（首版沿用现有地图存档文本）；HTTP 层用 Python FastAPI 作为极薄包装，通过子进程调用 engine 并返回 JSON。

本方案优先保障核心逻辑与可测试性；UI 和可视化不是重点，可后续追加。

## 路线与里程碑

- S1-M0：抽象契约与 CLI engine
    - 子命令：
        - generate <seed> <room_num> <extra_edges> <out_map_path>
        - shortest <map_path> <start> <goal>
        - top <map_path> <start> <goal> <k> [initial_power]
        - explore_shortest <map_path> <start> <goal> <initial_power>
        - bossmove <map_path> <out_map_path>
    - 输出：面向机器的单行/多行文本（便于 HTTP 包装解析）。

- S1-M1：HTTP 包装（FastAPI）
    - 端点：/generate, /shortest, /top, /explore, /bossmove
    - 实现：使用 Python 子进程与临时文件与 engine 交互，返回 JSON。

- S1-M2（可选）：迁移为 JSON 契约
    - 将地图读写从文本转为 JSON（字段：rooms、edges、boss_id 等）。
    - HTTP 层直接传 JSON，去除临时文件。

- S1-M3：测试与文档
    - 脚本化最小用例；README 与端点示例。

## CLI engine 契约（首版）

- generate
    - 输入：命令行参数 seed、room_num、extra_edges、out_map_path
    - 行为：生成地图并保存到 out_map_path（沿用 DungeonMap::save 文本格式）
    - 输出：`OK <out_map_path>`，失败输出 `ERR <msg>`（到 stderr，退出码非 0）

- shortest
    - 输入：map_path, start, goal
    - 输出：
        - 成功：`PATH <id0> <id1> ... <idN>`
        - 不可达：`PATH`（空路径）

- top
    - 输入：map_path, start, goal, k, [initial_power]
    - 输出：每条路径一行：
        - `PATH <rank> val=<v> pow=<p> : <id0> <id1> ... <idM>`

- explore_shortest
        - 输入：map_path, start, goal, initial_power
        - 行为：按最短路径依次收集战利品（不做随机战斗），报告最终武力与累计价值
        - 输出：`EXPLORE success=<0|1> power_end=<x> total_value=<y> progressed=<id0, id1, ...>`

- bossmove
        - 输入：map_path, out_map_path
        - 行为：Boss 向邻居移动一次（保持 Boss 唯一与最大强度），保存新地图
        - 输出：`BOSS <new_boss_id> <out_map_path>`

注：上述输出易于 Python 解析为 JSON；后续可切 JSON 原生 I/O。

## HTTP 端点（FastAPI）

- POST /generate { seed, room_num, extra_edges } → { map_path }
- POST /shortest { map_path, start, goal } → { path:[...] }
- POST /top { map_path, start, goal, k, initial_power? } → { paths:[{rank,val,pow,path:[...]}] }
- POST /explore { map_path, start, goal, initial_power } → { success, power_end, total_value, progressed:[...] }
- POST /bossmove { map_path } → { map_path, boss_id }

首版用临时文件承载地图；待 M2 迁移到纯 JSON。

## 运行与开发

- 编译：`make` 会产出 `bin/pj2` 和 `bin/engine`
- 本地快速试用：
  - 生成：`bin/engine generate 123 20 20 build/map.txt`
  - 最短：`bin/engine shortest build/map.txt 0 5`
- 启动 HTTP（可选）：`python3 web/server.py`（需要 Python3；默认端口 8090）
    - 访问静态页面：`http://localhost:8090/static/`（内含最小交互页面）

## 测试建议

- 针对每个子命令，准备 1-2 个固定输入与断言输出行的脚本测试
- 确保不影响现有 Phase1–4 测试（engine 为新增组件）
- Web 层仅为薄包装；如未安装 FastAPI/uvicorn，可只使用 engine 与脚本测试
