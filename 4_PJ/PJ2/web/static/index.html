<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PJ2 Web Demo</title>
    <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/vis-network@9.1.6/styles/vis-network.min.css" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 20px; }
      header { margin-bottom: 16px; }
      h1 { font-size: 18px; margin: 0 0 8px; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; flex: 1 1 320px; }
      label { display: block; font-size: 12px; color: #555; }
      input { padding: 6px 8px; width: 120px; }
      button { padding: 6px 10px; }
      pre { background: #f7f7f8; border: 1px solid #eee; border-radius: 8px; padding: 10px; overflow:auto; }
      .ok { color: #0a7; }
      .warn { color: #e67e22; }
      .err { color: #d33; }
      #map_canvas { width: 100%; height: 520px; border: 1px solid #ddd; border-radius: 8px; }
      .section-title { margin-top: 8px; margin-bottom: 8px; }
      textarea { width: 100%; min-height: 120px; }
    </style>
  </head>
  <body>
    <header>
      <h1>PJ2 Web Demo</h1>
      <div>极薄 Web 包装：生成地图、最短路径、Top 路径、探索、Boss 移动。</div>
    </header>

    <div class="row">
      <div class="card">
        <h2>生成地图</h2>
        <label>seed <input id="seed" type="number" value="123" /></label>
        <label>room_num <input id="room_num" type="number" value="20" /></label>
        <label>extra_edges <input id="extra_edges" type="number" value="20" /></label>
        <button onclick="genMap()">生成</button>
        <div id="gen_status" class="ok"></div>
        <button onclick="loadMapText()">查看文本地图</button>
        <pre id="map_text"></pre>
      </div>

      <div class="card">
        <h2>生成网格地图</h2>
        <label>width <input id="g_width" type="number" value="5" /></label>
        <label>height <input id="g_height" type="number" value="4" /></label>
        <label>seed <input id="g_seed" type="number" value="123" /></label>
        <button onclick="genGrid()">生成网格</button>
        <div id="grid_status" class="ok"></div>
      </div>

      <div class="card">
        <h2>最短路径</h2>
        <label>map_path <input id="map_path_short" type="text" value="build/map.txt" /></label>
        <label>start <input id="start" type="number" value="0" /></label>
        <label>goal <input id="goal" type="number" value="5" /></label>
        <button onclick="shortest()">查询</button>
        <pre id="shortest_out"></pre>
      </div>

      <div class="card">
        <h2>Top 路径</h2>
        <label>map_path <input id="map_path_top" type="text" value="build/map.txt" /></label>
        <label>k <input id="k" type="number" value="3" /></label>
        <label>initial_power <input id="initp" type="number" value="10" /></label>
        <button onclick="topPaths()">查询</button>
        <pre id="top_out"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>探索（按最短路径）</h2>
        <label>map_path <input id="map_path_ex" type="text" value="build/map.txt" /></label>
        <label>start <input id="start_ex" type="number" value="0" /></label>
        <label>goal <input id="goal_ex" type="number" value="5" /></label>
        <label>initial_power <input id="initp_ex" type="number" value="10" /></label>
        <button onclick="exploreShortest()">探索</button>
        <pre id="ex_out"></pre>
      </div>

      <div class="card">
        <h2>Boss 移动</h2>
        <label>map_path <input id="map_path_boss" type="text" value="build/map.txt" /></label>
        <button onclick="bossMove()">移动一次</button>
        <pre id="boss_out"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>邻接房间查询</h2>
        <label>map_path <input id="map_path_nbr" type="text" value="build/map_grid.txt" /></label>
        <label>room_id <input id="room_nbr" type="number" value="0" /></label>
        <button onclick="neighbors()">查询邻接</button>
        <pre id="nbr_out"></pre>
      </div>

      <div class="card">
        <h2>交互移动（含战斗与收集）</h2>
        <label>map_path <input id="map_path_step" type="text" value="build/map_grid.txt" /></label>
        <label>out_map_path <input id="out_map_step" type="text" value="build/map_step.txt" /></label>
        <label>pos <input id="pos_step" type="number" value="0" /></label>
        <label>next <input id="next_step" type="number" value="1" /></label>
        <label>power <input id="power_step" type="number" value="10" /></label>
        <button onclick="stepMove()">前往</button>
        <pre id="step_out"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex: 1 1 720px; min-width: 480px;">
        <h2 class="section-title">地图可视化（Vis.js）</h2>
        <div style="margin-bottom: 8px; font-size: 12px; color: #555;">点击节点可尝试移动（需与当前节点邻接）。Start=绿色，Boss=红色，Treasure=金色，已访问=灰色。</div>
        <div id="map_canvas"></div>
        <div id="map_status" class="ok" style="margin-top:6px;"></div>
        <div style="font-size: 12px;">玩家位置: <span id="player_pos">-</span> | 武力: <span id="player_power">-</span> | 总价值: <span id="player_value">-</span></div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <button onclick="waitBoss()">等待（触发Boss移动）</button>
          <span style="font-size:12px; color:#555;">每移动3步也会自动触发一次 Boss 移动与路径重算。</span>
        </div>
      </div>
    </div>

    <div id="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:999;">
      <div style="background:#fff; padding:20px; border-radius:12px; min-width:260px; text-align:center; box-shadow:0 8px 24px rgba(0,0,0,0.2);">
        <h3 id="modal_title">游戏结束</h3>
        <p id="modal_msg"></p>
        <button onclick="closeModalAndReset()">重新生成地图</button>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex: 1 1 360px;">
        <h2 class="section-title">战利品树</h2>
        <div style="font-size: 12px; color:#555;">在下方粘贴 LootTree JSON（或未来接口返回），点击渲染。</div>
        <textarea id="loot_json" placeholder='{"label":"Root","children":[{"label":"Weapon","children":[{"label":"Sword","favorite":true}]}]}'></textarea>
        <button onclick="renderLootFromInput()">渲染战利品树</button>
        <div id="loot_tree"></div>
      </div>
    </div>

    <script src="/static/app.js"></script>
  </body>
</html>
